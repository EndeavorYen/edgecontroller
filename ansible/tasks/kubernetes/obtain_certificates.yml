# Copyright 2019 Intel Corporation. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

- name: Execute kubeconfig user command
  shell: "kubeadm alpha kubeconfig user --client-name=openness-controller > certs.tmp"

- name: Create kubernetes folder to store certificates
  file:
    name: /etc/kubernetes-certs
    state: directory
    mode: '0660'
    owner: root
    group: root

- name: Save certificate pem files to disk
  shell: "{{ item }}"
  with_items:
  - "cat certs.tmp | grep 'certificate-authority-data: ' | sed 's/.*certificate-authority-data: //' | base64 -d > {{ CCE_K8S_CLIENT_CA_PATH }}"
  - "cat certs.tmp | grep 'client-certificate-data: ' | sed 's/.*client-certificate-data: //' | base64 -d > {{ CCE_K8S_CLIENT_CERT_PATH }}"
  - "cat certs.tmp | grep 'client-key-data: ' | sed 's/.*client-key-data: //' | base64 -d > {{ CCE_K8S_CLIENT_KEY_PATH }}"
  - "rm -f certs.tmp"
