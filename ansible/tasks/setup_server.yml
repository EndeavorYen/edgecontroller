# Copyright 2019 Intel Corporation. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---
- hosts: localhost
  any_errors_fatal: false
  tasks:
  - debug:
      msg: "--- SETTING UP CONTROLLER ---"
  - include_vars: ../vars/defaults.yml

  - debug:
      msg: "Base path set to: {{ base_path }}"

  # Host OS setup
  - include_tasks: "{{ base_path }}/tasks/os/check_hostname_string.yml"
  - include_tasks: "{{ base_path }}/tasks/os/disable_selinux_permanently.yml"
  - include_tasks: "{{ base_path }}/tasks/os/disable_selinux_temporarily.yml"
  - include_tasks: "{{ base_path }}/tasks/os/disable_swap_permanently.yml"
  - include_tasks: "{{ base_path }}/tasks/os/disable_swap_temporarily.yml"
  - include_tasks: "{{ base_path }}/tasks/os/remove_os_proxy.yml"
  - include_tasks: "{{ base_path }}/tasks/os/add_os_proxy.yml"
  - include_tasks: "{{ base_path }}/tasks/os/yum_keepcache.yml"
  - include_tasks: "{{ base_path }}/tasks/os/install_epel_package.yml"
  - include_tasks: "{{ base_path }}/tasks/os/install_mysql_repo_package.yml"
  - include_tasks: "{{ base_path }}/tasks/os/install_base_packages.yml"

  - include_tasks: "{{ base_path }}/tasks/kubernetes/kubelet_stop.yml"
  - include_tasks: "{{ base_path }}/tasks/docker/containerd_stop.yml"
  - include_tasks: "{{ base_path }}/tasks/kubernetes/reset.yml"
  - include_tasks: "{{ base_path }}/tasks/docker/restart.yml"
  - include_tasks: "{{ base_path }}/tasks/docker/remove_images_and_containers.yml"
  - include_tasks: "{{ base_path }}/tasks/docker/stop.yml"
  - include_tasks: "{{ base_path }}/tasks/docker/uninstall_legacy.yml"
  - include_tasks: "{{ base_path }}/tasks/docker/uninstall.yml"
  - include_tasks: "{{ base_path }}/tasks/docker/remove_config_files.yml"
  - include_tasks: "{{ base_path }}/tasks/docker/remove_compose_tool.yml"

  - include_tasks: "{{ base_path }}/tasks/ovs/stop_and_destroy.yml"
  - include_tasks: "{{ base_path }}/tasks/ovs/uninstall_legacy.yml"

  - include_tasks: "{{ base_path }}/tasks/os/firewall_enable.yml"
  - include_tasks: "{{ base_path }}/tasks/os/firewall_restart.yml"

  - include_tasks: "{{ base_path }}/tasks/docker/install_repo.yml"
  - include_tasks: "{{ base_path }}/tasks/docker/install.yml"
  - include_tasks: "{{ base_path }}/tasks/docker/enable.yml"
  - include_tasks: "{{ base_path }}/tasks/docker/install_compose_tool.yml"
  - include_tasks: "{{ base_path }}/tasks/docker/daemon_proxy_remove.yml"
  - include_tasks: "{{ base_path }}/tasks/docker/daemon_proxy_add.yml"
  - include_tasks: "{{ base_path }}/tasks/docker/status.yml"
  - include_tasks: "{{ base_path }}/tasks/docker/stop.yml"
  - include_tasks: "{{ base_path }}/tasks/docker/firewall_basic_rules.yml"

  - include_tasks: "{{ base_path }}/tasks/os/reload_systemctl.yml"
  - include_tasks: "{{ base_path }}/tasks/os/reload_firewall_rules.yml"
  - include_tasks: "{{ base_path }}/tasks/docker/restart.yml"
  - include_tasks: "{{ base_path }}/tasks/os/mysql_client_uninstall.yml"
  - include_tasks: "{{ base_path }}/tasks/os/mysql_client_install.yml"  

  - include_tasks: "{{ base_path }}/tasks/build/ui_proxy_revert.yml"
  - include_tasks: "{{ base_path }}/tasks/build/ui_proxy_set.yml"
  - include_tasks: "{{ base_path }}/tasks/build/build_proxy_revert.yml"
  - include_tasks: "{{ base_path }}/tasks/build/build_proxy_set.yml"
  - include_tasks: "{{ base_path }}/tasks/build/add_cached_modules_support.yml"

  # Configure additional features depending on selected deployment mode
  - name: Configure kubernetes and kubernetes-ovn mode (common part)
    block:
      - include_tasks: "{{ base_path }}/tasks/kubernetes/uninstall_legacy.yml"
      - include_tasks: "{{ base_path }}/tasks/kubernetes/install_repo.yml"
      - include_tasks: "{{ base_path }}/tasks/kubernetes/install_kubernetes_base_packages.yml"
      - include_tasks: "{{ base_path }}/tasks/kubernetes/kubelet_config_proxy_remove.yml"
      - include_tasks: "{{ base_path }}/tasks/kubernetes/kubelet_config_proxy_add.yml"
      - include_tasks: "{{ base_path }}/tasks/kubernetes/k8s_sysctl_flags_add.yml"
      - include_tasks: "{{ base_path }}/tasks/kubernetes/kubelet_enable.yml"
      - include_tasks: "{{ base_path }}/tasks/kubernetes/patch_kubelet_service_file.yml"
      - include_tasks: "{{ base_path }}/tasks/os/reload_systemctl.yml"
      - include_tasks: "{{ base_path }}/tasks/os/reload_sysctl_settings.yml"
      - include_tasks: "{{ base_path }}/tasks/kubernetes/kubelet_start.yml"
      - include_tasks: "{{ base_path }}/tasks/docker/restart.yml"
      - include_tasks: "{{ base_path }}/tasks/kubernetes/firewall_common_add.yml"
    when: (CCE_ORCHESTRATION_MODE == "kubernetes") or
          (CCE_ORCHESTRATION_MODE == "kubernetes-ovn")
 
  - name: Additional configuration for kubernetes mode
    block:
      - include_tasks: "{{ base_path }}/tasks/os/reload_firewall_rules.yml"
      - include_tasks: "{{ base_path }}/tasks/kubernetes/flannel_mode_init.yml"
    when: CCE_ORCHESTRATION_MODE == "kubernetes"
 
  - name: Additional configuration for kubernetes-ovn mode
    block:
      - include_tasks: "{{ base_path }}/tasks/kubernetes/firewall_kubeovn_add.yml"
      - include_tasks: "{{ base_path }}/tasks/os/reload_firewall_rules.yml"
      - include_tasks: "{{ base_path }}/tasks/kubernetes/kubeovn_mode_init.yml"
    when: CCE_ORCHESTRATION_MODE == "kubernetes-ovn"

  - name: Obtain kubernetes certificates
    block:
      - include_tasks: "{{ base_path }}/tasks/kubernetes/grant_cluster_admin_rights.yml"
      - include_tasks: "{{ base_path }}/tasks/kubernetes/obtain_certificates.yml"
    when: (CCE_ORCHESTRATION_MODE == "kubernetes") or
          (CCE_ORCHESTRATION_MODE == "kubernetes-ovn")

  # Generate build .env file based on provided data in vars/defaults.yml file
  - include_tasks: "{{ base_path }}/tasks/build/env_file_backup_original.yml"
  - include_tasks: "{{ base_path }}/tasks/build/env_file_generate.yml"

  # Build containers and start them
  - include_tasks: "{{ base_path }}/tasks/build/build_controller.yml"
  - include_tasks: "{{ base_path }}/tasks/build/start_controller.yml"

  - include_tasks: "{{ base_path }}/tasks/kubernetes/print_join_command.yml"
    when: (CCE_ORCHESTRATION_MODE == "kubernetes") or
          (CCE_ORCHESTRATION_MODE == "kubernetes-ovn")

  - include_tasks: "{{ base_path }}/tasks/other/script_success.yml"
